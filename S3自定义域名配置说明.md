# S3 自定义域名配置说明

## 📋 配置概述

为了避免 Tebi.io 直接访问被封号，我们使用自定义域名来访问 S3 桶。

## 🔧 配置步骤

### 1. Tebi.io 端配置

1. **创建新桶**：桶名必须与你的域名一致
   - 桶名：`ltygames2.88mac.cn`

2. **设置桶权限**：
   - 确保桶设置为公开读取（Public Read）
   - ACL 策略允许公开访问

### 2. DNS 配置

在你的域名管理面板（如阿里云、腾讯云等）添加 CNAME 记录：

```
类型：CNAME
主机记录：ltygames
记录值：ltygames2.88mac.cn.s3.tebi.io
TTL：600（或默认）
```

### 3. 代码配置

已完成的配置：

#### 后端配置 (`backend/config.py`)
```python
S3_BUCKET = 'ltygames2.88mac.cn'  # 桶名与域名一致
S3_CUSTOM_DOMAIN = 'https://ltygames2.88mac.cn'  # 自定义域名用于访问
```

#### 环境变量 (`backend/.env`)
```env
S3_BUCKET=ltygames2.88mac.cn
S3_CUSTOM_DOMAIN=https://ltygames2.88mac.cn
```

## 🔄 工作原理

### 上传流程
1. 后端使用 boto3 连接到 `https://s3.tebi.io`
2. 上传文件到桶 `ltygames2.88mac.cn`
3. 文件路径：`games/timestamp-filename.ext`

### 访问流程
1. 生成的 URL：`https://ltygames2.88mac.cn/games/timestamp-filename.ext`
2. DNS 解析：`ltygames2.88mac.cn` → `ltygames2.88mac.cn.s3.tebi.io`
3. Tebi.io 识别桶名并返回文件

## ✅ 验证配置

### 1. 测试 DNS 解析
```bash
nslookup ltygames2.88mac.cn
# 应该返回 CNAME 记录指向 ltygames2.88mac.cn.s3.tebi.io
```

### 2. 测试上传
上传一个文件后，检查返回的 URL：
```
https://ltygames2.88mac.cn/games/1234567890-test.exe
```

### 3. 测试访问
在浏览器中直接访问上传后的 URL，应该能够下载文件。

## 🎯 优势

1. **防封号**：不直接暴露 `s3.tebi.io` 域名
2. **品牌化**：使用自己的域名更专业
3. **灵活性**：可以随时更换存储服务商而不影响前端 URL
4. **CDN 友好**：可以在自定义域名前加 CDN 加速

## ⚠️ 注意事项

1. **桶名必须与域名完全一致**
2. **CNAME 记录格式**：`your-bucket-name.s3.tebi.io`（注意末尾的 `.s3.tebi.io`）
3. **DNS 生效时间**：通常需要 10 分钟到 1 小时
4. **HTTPS 支持**：Tebi.io 自动为自定义域名提供 SSL 证书

## 🔍 故障排查

### 问题：访问自定义域名返回 404
- 检查 DNS CNAME 记录是否正确
- 确认桶名与域名完全一致
- 等待 DNS 生效（最多 24 小时）

### 问题：上传成功但无法访问
- 检查桶的 ACL 权限设置
- 确认文件的 ACL 为 `public-read`
- 检查 `S3_CUSTOM_DOMAIN` 配置是否正确

### 问题：上传失败
- 检查 S3 凭证是否正确
- 确认桶名在 Tebi.io 中存在
- 查看后端日志获取详细错误信息
